name: CI/CD Pipeline

# –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å workflow
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  # –ó–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
  workflow_dispatch:

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
env:
  PYTHON_VERSION: '3.11'

# JOBS - –∑–∞–¥–∞—á–∏ –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è
jobs:
  # 1. –õ–∏–Ω—Ç–∏–Ω–≥ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
  lint:
    name: üìù –õ–∏–Ω—Ç–∏–Ω–≥ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
    
    - name: üêç –ü—Ä–æ–≤–µ—Ä–∫–∞ Python —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º Python —Ñ–∞–π–ª—ã..."
        if ls *.py 1> /dev/null 2>&1; then
          python -m py_compile *.py 2>/dev/null && echo "‚úÖ Python —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
        else
          echo "üì≠ –ù–µ—Ç Python —Ñ–∞–π–ª–æ–≤"
        fi
    
    - name: üêö –ü—Ä–æ–≤–µ—Ä–∫–∞ bash —Å–∫—Ä–∏–ø—Ç–æ–≤
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º bash —Å–∫—Ä–∏–ø—Ç—ã..."
        if ls scripts/*.sh 1> /dev/null 2>&1; then
          sudo apt-get update
          sudo apt-get install -y shellcheck
          shellcheck scripts/*.sh || echo "‚ö†Ô∏è  –ï—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ bash —Å–∫—Ä–∏–ø—Ç–∞—Ö"
        else
          echo "üì≠ –ù–µ—Ç bash —Å–∫—Ä–∏–ø—Ç–æ–≤"
        fi
    
    - name: üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ YAML —Ñ–∞–π–ª–æ–≤
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º YAML —Ñ–∞–π–ª—ã..."
        python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))" && echo "‚úÖ YAML —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
      continue-on-error: true

  # 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  test:
    name: üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    runs-on: ubuntu-latest
    needs: lint  # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—Ö–∞ –ª–∏–Ω—Ç–∏–Ω–≥–∞
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
    
    - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          echo "üì≠ requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º pytest –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
          pip install pytest
        fi
    
    - name: üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      run: |
        echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
        # –ò—â–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
        if ls test_*.py 1> /dev/null 2>&1; then
          python -m pytest test_*.py -v
        elif [ -f test_calculator.py ]; then
          python test_calculator.py
        else
          echo "üì≠ –¢–µ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–æ–∑–¥–∞–µ–º –ø—Ä–∏–º–µ—Ä..."
          # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –µ—Å–ª–∏ –Ω–µ—Ç
          cat > simple_test.py << 'TESTEOF'
def test_example():
    assert 1 + 1 == 2
    print("‚úÖ –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω")

if __name__ == "__main__":
    test_example()
TESTEOF
          python simple_test.py
        fi
    
    - name: üìä –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
      run: |
        echo "–ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞..."
        if [ -f calculator.py ]; then
          python calculator.py
        elif [ -f *.py ]; then
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π python —Ñ–∞–π–ª
          FIRST_PY=$(ls *.py | head -1)
          echo "–ó–∞–ø—É—Å–∫–∞–µ–º $FIRST_PY"
          python "$FIRST_PY"
        else
          echo "üì≠ –ù–µ—Ç Python —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∑–∞–ø—É—Å–∫–∞"
        fi

  # 3. –°–±–æ—Ä–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
  build:
    name: üèóÔ∏è –°–±–æ—Ä–∫–∞
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
    
    - name: üê≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ Dockerfile
      run: |
        if [ -f Dockerfile ]; then
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º Dockerfile..."
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker CLI
          sudo apt-get update
          sudo apt-get install -y docker.io
          docker build . --dry-run
          echo "‚úÖ Dockerfile –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
        else
          echo "üì≠ Dockerfile –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
    
    - name: üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞
      run: |
        echo "–°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –ø—Ä–æ–µ–∫—Ç–∞..."
        tar -czf project-backup-$(date +%Y%m%d).tar.gz ./* 2>/dev/null || true
        ls -la *.tar.gz 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞—Ä—Ö–∏–≤"

  # 4. Security –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è Kali)
  security:
    name: üîí Security –ø—Ä–æ–≤–µ—Ä–∫–∏
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
    
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–æ–¥–µ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π action)
      uses: zricethezav/gitleaks-action@v1.6.0
    
    - name: üêç –ü—Ä–æ–≤–µ—Ä–∫–∞ Python —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π (Bandit)
      run: |
        pip install bandit
        bandit -r . -f json -o bandit-report.json 2>/dev/null || true
        if [ -f bandit-report.json ]; then
          echo "‚úÖ Bandit –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω"
          # –ü–æ–∫–∞–∂–µ–º –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
          python3 -c "import json; data=json.load(open('bandit-report.json')); print(f'–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º: {len(data.get(\"results\", []))}')"
        else
          echo "üì≠ Bandit –æ—Ç—á–µ—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω"
        fi
    
    - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ security –æ—Ç—á–µ—Ç–∞
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
          .gitleaks/*.json
        retention-days: 7

  # 5. –§–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥ - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  notify:
    name: üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    runs-on: ubuntu-latest
    needs: [lint, test, build, security]
    if: always()  # –í—Å–µ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
    
    steps:
    - name: üìä –°–≤–æ–¥–∫–∞
      run: |
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë         CI/CD Pipeline Results           ‚ïë"
        echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
        echo "‚ïë Repository: ${{ github.repository }}     ‚ïë"
        echo "‚ïë Branch: ${{ github.ref }}                ‚ïë"
        echo "‚ïë Commit: ${{ github.sha }}                ‚ïë"
        echo "‚ïë Author: ${{ github.actor }}              ‚ïë"
        echo "‚ïë Time: $(date)                            ‚ïë"
        echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å
        if [ "${{ needs.lint.result }}" = "success" ] && [ "${{ needs.test.result }}" = "success" ]; then
          echo "‚ïë Status: ‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´            ‚ïë"
          echo "‚ïë                                          ‚ïë"
          echo "‚ïë –û—Ç—á–µ—Ç –ø–æ –∑–∞–¥–∞—á–∞–º:                       ‚ïë"
          echo "‚ïë ‚Ä¢ –õ–∏–Ω—Ç–∏–Ω–≥: ‚úÖ –£—Å–ø–µ—à–Ω–æ                   ‚ïë"
          echo "‚ïë ‚Ä¢ –¢–µ—Å—Ç—ã: ‚úÖ –£—Å–ø–µ—à–Ω–æ                     ‚ïë"
          echo "‚ïë ‚Ä¢ –°–±–æ—Ä–∫–∞: ${{ needs.build.result }}     ‚ïë"
          echo "‚ïë ‚Ä¢ Security: ${{ needs.security.result }}‚ïë"
        else
          echo "‚ïë Status: ‚ùå –ï–°–¢–¨ –û–®–ò–ë–ö–ò                  ‚ïë"
          echo "‚ïë                                          ‚ïë"
          echo "‚ïë –ü—Ä–æ–±–ª–µ–º—ã –≤ –∑–∞–¥–∞—á–∞—Ö:                     ‚ïë"
          echo "‚ïë ‚Ä¢ –õ–∏–Ω—Ç–∏–Ω–≥: ${{ needs.lint.result }}     ‚ïë"
          echo "‚ïë ‚Ä¢ –¢–µ—Å—Ç—ã: ${{ needs.test.result }}       ‚ïë"
          echo "‚ïë ‚Ä¢ –°–±–æ—Ä–∫–∞: ${{ needs.build.result }}     ‚ïë"
          echo "‚ïë ‚Ä¢ Security: ${{ needs.security.result }}‚ïë"
        fi
        
        echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
        echo "‚ïë –°—Å—ã–ª–∫–∞ –Ω–∞ workflow:                      ‚ïë"
        echo "‚ïë https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    
    - name: üéØ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
      if: always()
      uses: actions/download-artifact@v4
      with:
        name: security-reports
        path: ./artifacts/
      continue-on-error: true
    
    - name: üìÅ –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
      run: |
        echo "–°–æ–∑–¥–∞–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:"
        find . -name "*.tar.gz" -o -name "*.json" -o -name "*.xml" 2>/dev/null || echo "–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
