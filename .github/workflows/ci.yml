name: CI/CD Pipeline

# ĞšĞ¾Ğ³Ğ´Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ workflow
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¸Ğ· Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°
  workflow_dispatch:

# ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

# JOBS - Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒÑÑ
jobs:
  # 1. Ğ›Ğ¸Ğ½Ñ‚Ğ¸Ğ½Ğ³ Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ´Ğ°
  lint:
    name: ğŸ“ Ğ›Ğ¸Ğ½Ñ‚Ğ¸Ğ½Ğ³ Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4
    
    - name: ğŸ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Python ÑĞ¸Ğ½Ñ‚Ğ°ĞºÑĞ¸ÑĞ°
      run: |
        echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Python Ñ„Ğ°Ğ¹Ğ»Ñ‹..."
        python -m py_compile *.py 2>/dev/null || echo "ĞĞµÑ‚ Python Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²"
    
    - name: ğŸš ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° bash ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ²
      run: |
        echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ bash ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ñ‹..."
        if ls scripts/*.sh 1> /dev/null 2>&1; then
          sudo apt-get install -y shellcheck
          shellcheck scripts/*.sh || true
        else
          echo "ĞĞµÑ‚ bash ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ²"
        fi
    
    - name: ğŸ“‹ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° YAML Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
      uses: actions-hub/yamllint@master
      with:
        file: .github/workflows/ci.yml

  # 2. Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
  test:
    name: ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    runs-on: ubuntu-latest
    needs: lint  # Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ ÑƒÑĞ¿ĞµÑ…Ğ° Ğ»Ğ¸Ğ½Ñ‚Ğ¸Ğ½Ğ³Ğ°
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4
    
    - name: ğŸ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
    
    - name: ğŸ§ª Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ²
      run: |
        echo "Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ²..."
        # Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ñ‚ĞµÑÑ‚Ñ‹ - Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼
        if [ -f test_*.py ]; then
          python -m pytest test_*.py -v
        else
          echo "Ğ¢ĞµÑÑ‚Ğ¾Ğ² Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾"
        fi
    
    - name: ğŸ“Š Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°
      run: |
        echo "Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°..."
        if [ -f calculator.py ]; then
          python calculator.py
        fi

  # 3. Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾)
  build:
    name: ğŸ—ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ°
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4
    
    - name: ğŸ³ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Dockerfile
      run: |
        if [ -f Dockerfile ]; then
          echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Dockerfile..."
          docker build . --dry-run
        else
          echo "Dockerfile Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
        fi
    
    - name: ğŸ“¦ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°
      run: |
        echo "Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ°Ñ€Ñ…Ğ¸Ğ² Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°..."
        tar -czf project-backup-$(date +%Y%m%d).tar.gz ./*

  # 4. Security Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ (Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Kali)
  security:
    name: ğŸ”’ Security Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4
    
    - name: ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ² Ğ² ĞºĞ¾Ğ´Ğµ
      uses: actions/gitleaks-action@v2
      with:
        config-path: .gitleaks.toml
    
    - name: ğŸ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Python ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ (Bandit)
      run: |
        pip install bandit
        bandit -r . -f json -o bandit-report.json || true
    
    - name: ğŸ“¤ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° security Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: bandit-report.json
        retention-days: 7

  # 5. Kali Linux ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹ (Ñ‡ĞµÑ€ĞµĞ· self-hosted runner)
  kali-tests:
    name: ğŸ¯ Kali Linux Ñ‚ĞµÑÑ‚Ñ‹
    runs-on: [self-hosted, linux, kali]  # Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ self-hosted runner
    if: false  # ĞÑ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4
    
    - name: ğŸ”“ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
      run: |
        echo "ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Kali..."
        sudo apt-get update -q
    
    - name: ğŸ› ï¸ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
      run: |
        echo "Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹..."
        sudo apt-get install -y -q nmap whois dnsutils

  # 6. Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑˆĞ°Ğ³ - ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
  notify:
    name: ğŸ“¢ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
    runs-on: ubuntu-latest
    needs: [lint, test, build, security]
    if: always()  # Ğ’ÑĞµĞ³Ğ´Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ, Ğ´Ğ°Ğ¶Ğµ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…
    
    steps:
    - name: ğŸ“Š Ğ¡Ğ²Ğ¾Ğ´ĞºĞ°
      run: |
        echo "ğŸ‰ CI/CD Pipeline Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½!"
        echo "Ğ’Ñ€ĞµĞ¼Ñ: $(date)"
        echo "Ğ’ĞµÑ‚ĞºĞ°: ${{ github.ref }}"
        echo "ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: ${{ github.sha }}"
        echo "ĞĞ²Ñ‚Ğ¾Ñ€: ${{ github.actor }}"
        echo ""
        echo "Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° workflow:"
        echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
    
    - name: ğŸ¨ ĞšÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
      if: success()
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘     âœ… Ğ’Ğ¡Ğ• Ğ¢Ğ•Ğ¡Ğ¢Ğ« ĞŸĞ ĞĞ™Ğ”Ğ•ĞĞ«    â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    - name: âš ï¸ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
      if: failure()
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘     âŒ Ğ¢Ğ•Ğ¡Ğ¢Ğ« ĞĞ• ĞŸĞ ĞĞ™Ğ”Ğ•ĞĞ«     â•‘"
        echo "â•‘   ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸ Ğ²Ñ‹ÑˆĞµ!       â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
