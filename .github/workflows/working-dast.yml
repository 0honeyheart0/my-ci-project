name: Working DAST
on: push

jobs:
  dast:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name:  Setup Docker
      uses: docker/setup-buildx-action@v2
    
    - name:  Build and run with Docker
      run: |
        # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Docker Ğ¾Ğ±Ñ€Ğ°Ğ·
        docker build -t myapp .
        
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
        docker run -d -p 5000:5000 --name myapp-container myapp
        
        # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
        sleep 10
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼
        curl -s http://localhost:5000 && echo "âœ… App running in Docker"
    
    - name:  Basic scan with nmap
      run: |
        sudo apt-get update
        sudo apt-get install -y nmap
        
        echo "ğŸ” Scanning with nmap..."
        nmap -sV -p 5000 localhost
    
    - name:  OWASP ZAP Full Scan
      run: |
        echo "ğŸ” Starting OWASP ZAP scan..."
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ´Ğ»Ñ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ¾Ğ²
        mkdir -p zap-reports
        
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ZAP Ğ² Docker
        docker run --network host -v $PWD/zap-reports:/zap/wrk:rw \
          -t ghcr.io/zaproxy/zaproxy:stable \
          zap-full-scan.py \
          -t http://localhost:5000 \
          -r /zap/wrk/zap-report.html
          -I  # -I Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ, Ğ½Ğµ Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…
          
        echo "âœ… ZAP scan completed"
      continue-on-error: true  # ĞĞµ Ğ¾ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ workflow Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ñ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğ¸ ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
    
    - name:  Upload ZAP Report
      uses: actions/upload-artifact@v4
      with:
        name: zap-security-report
        path: zap-reports/zap-report.html
        if-no-files-found: warn  # ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´Ğ°ĞµÑ‚, ĞµÑĞ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ»ÑÑ
    
    - name: Show scan summary
      run: |
        echo "=== SCAN RESULTS ==="
        echo "âœ… Nmap scan completed"
        if [ -f zap-reports/zap-report.html ]; then
          echo "âœ… ZAP report generated: zap-reports/zap-report.html"
          echo "ğŸ“Š Download it from Artifacts section"
        else
          echo "âš ï¸ ZAP report not found (scan may have failed)"
        fi
    
    - name:  Cleanup
      if: always()
      run: |
        docker stop myapp-container 2>/dev/null || true
        docker rm myapp-container 2>/dev/null || true
        echo "ğŸ§¹ Cleanup completed"
